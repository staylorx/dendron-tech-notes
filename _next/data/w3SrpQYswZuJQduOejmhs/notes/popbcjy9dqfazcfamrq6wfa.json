{"pageProps":{"note":{"id":"popbcjy9dqfazcfamrq6wfa","title":"Install","desc":"","updated":1659538110902,"created":1659537090941,"custom":{},"fname":"tools.kubernetes.rke2.install","type":"note","vault":{"fsPath":"notes"},"contentHash":"84b66c97d55b8163d825ed5424ad3e83","links":[{"type":"wiki","from":{"fname":"tools.kubernetes.rke2.install","id":"popbcjy9dqfazcfamrq6wfa","vaultName":"notes"},"value":"tools.nexus.mirrors","alias":"Mirrors","position":{"start":{"line":75,"column":203,"offset":1690},"end":{"line":75,"column":234,"offset":1721},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"tools.nexus.mirrors"}}],"anchors":{"for-all-machines":{"type":"header","text":"For all machines","value":"for-all-machines","line":8,"column":0,"depth":2},"create-masters":{"type":"header","text":"Create Masters","value":"create-masters","line":26,"column":0,"depth":2},"workers":{"type":"header","text":"Workers","value":"workers","line":56,"column":0,"depth":2},"airgap-note":{"type":"header","text":"Airgap note","value":"airgap-note","line":74,"column":0,"depth":2}},"children":[],"parent":"o8ryrdti1110cj19a5tq1oh","data":{}},"body":"<h1 id=\"install\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#install\"></a>Install</h1>\n<h2 id=\"for-all-machines\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#for-all-machines\"></a>For all machines</h2>\n<p>Create a folder for the config file.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> -p /etc/rancher/rke2\n<span class=\"token builtin class-name\">cd</span> /etc/rancher/rke2\n</code></pre>\n<p>Create a file <code>registries.yaml</code>,</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">mirrors</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">docker.io</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">endpoint</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"http://192.168.1.11:8880\"</span>\n</code></pre>\n<h2 id=\"create-masters\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#create-masters\"></a>Create Masters</h2>\n<p>Create a file <code>config.yaml</code>,</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> your_secret_token\n<span class=\"token comment\"># Commented for the first master, but uncomment this for extra masters</span>\n<span class=\"token comment\"># server: https://kubernetes.local:9345</span>\n<span class=\"token key atrule\">tls-san</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> kubernetes.local\n  <span class=\"token punctuation\">-</span> 127.0.0.1\n<span class=\"token key atrule\">cluster-cidr</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10.42.0.0/16\"</span>\n<span class=\"token key atrule\">service-cidr</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10.43.0.0/16\"</span>\n<span class=\"token key atrule\">node-taint</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"CriticalAddonsOnly=true:NoExecute\"</span>\n<span class=\"token key atrule\">disable-cloud-controller</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token comment\"># debug: true</span>\n<span class=\"token key atrule\">cni</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> calico\n</code></pre>\n<p>Install the bins for master,</p>\n<pre><code>curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=v1.24 sh -\nsystemctl enable rke2-server.service\n</code></pre>\n<p>Start the service,\nsystemctl start rke2-server.service</p>\n<h2 id=\"workers\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#workers\"></a>Workers</h2>\n<p>Create config.yaml files,</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> your_secret_token\n<span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes.local<span class=\"token punctuation\">:</span><span class=\"token number\">9345</span>\n<span class=\"token comment\"># debug: true</span>\n</code></pre>\n<p>Install the bins for workers,</p>\n<pre><code>curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=\"agent\" INSTALL_RKE2_CHANNEL=v1.24 sh -\nsystemctl enable rke2-agent.service\n</code></pre>\n<p>Start the service,\nsystemctl start rke2-agent.service</p>\n<h2 id=\"airgap-note\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#airgap-note\"></a>Airgap note</h2>\n<p>I airgap install quite a bit since bandwitdh can be precious and docker hub's ultimately not free.</p>\n<p>To cache the images copy the files from the release, e.g., <a href=\"https://github.com/rancher/rke2/releases/download/v1.24.3%2Brke2r1/rke2-images-all.linux-amd64.txt\">https://github.com/rancher/rke2/releases/download/v1.24.3%2Brke2r1/rke2-images-all.linux-amd64.txt</a>.</p>\n<p>Create a script to pre-pull each of the images. The following assumes the downloaded images file above is called <code>rancher_images_file.txt</code>. It also assumes your docker deamon has been configured to use <a href=\"/dendron-tech-notes/notes/szlb6ma4pbf2mbt9vw4gk8r\">Mirrors</a>.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token builtin class-name\">read</span> p<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  <span class=\"token function\">docker</span> pull <span class=\"token string\">\"<span class=\"token variable\">$p</span>\"</span> \n<span class=\"token keyword\">done</span> <span class=\"token operator\">&#x3C;</span>rancher_images_file.txt\n</code></pre>","noteIndex":{"id":"mxgc4uwkaggbr33skdyr3er","title":"Root","desc":"","updated":1658781980025,"created":1658781841009,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"notes"},"contentHash":"cd32b46dedcf30d08822d76b765cfad7","links":[],"anchors":{"welcome-to-tech-notes":{"type":"header","text":"Welcome to Tech Notes","value":"welcome-to-tech-notes","line":7,"column":0,"depth":1}},"children":["9mb2ancyhiisd1t0ri8enmf","k11gwwa49rz1xy90k5ujoia"],"parent":null,"data":{},"body":"# Welcome to Tech Notes\n\nThis was originally stood up to collect gists from github, snippets from gitlab, and any other bits and bobbles spread across the SVCs of my business."},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"notes"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"task","dateFormat":"y.MM.dd","addBehavior":"asOwnDomain","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":true,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"enableFullHierarchyNoteTitle":false,"enableHandlebarTemplates":true,"enableSmartRefs":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false},"publishing":{"assetsPrefix":"/dendron-tech-notes","siteUrl":"https://staylorx.github.io","enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":true,"siteRootDir":"docs","seo":{"title":"Dendron Tech Notes","description":"Collection of notes related to technology"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enablePrettyLinks":true,"duplicateNoteBehavior":{"action":"useVault","payload":["notes"]},"enableTaskNotes":true,"siteFaviconPath":"favicon.ico","siteIndex":"root","searchMode":"lookup"}}},"__N_SSG":true}