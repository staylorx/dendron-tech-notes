<h1 id="install"><a aria-hidden="true" class="anchor-heading icon-link" href="#install"></a>Install</h1>
<h2 id="for-all-machines"><a aria-hidden="true" class="anchor-heading icon-link" href="#for-all-machines"></a>For all machines</h2>
<p>Create a folder for the config file.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /etc/rancher/rke2
<span class="token builtin class-name">cd</span> /etc/rancher/rke2
</code></pre>
<p>Create a file <code>registries.yaml</code>,</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">docker.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"http://192.168.1.11:8880"</span>
</code></pre>
<h2 id="create-masters"><a aria-hidden="true" class="anchor-heading icon-link" href="#create-masters"></a>Create Masters</h2>
<p>Create a file <code>config.yaml</code>,</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">token</span><span class="token punctuation">:</span> your_secret_token
<span class="token comment"># Commented for the first master, but uncomment this for extra masters</span>
<span class="token comment"># server: https://kubernetes.local:9345</span>
<span class="token key atrule">tls-san</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> kubernetes.local
  <span class="token punctuation">-</span> 127.0.0.1
<span class="token key atrule">cluster-cidr</span><span class="token punctuation">:</span> <span class="token string">"10.42.0.0/16"</span>
<span class="token key atrule">service-cidr</span><span class="token punctuation">:</span> <span class="token string">"10.43.0.0/16"</span>
<span class="token key atrule">node-taint</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"CriticalAddonsOnly=true:NoExecute"</span>
<span class="token key atrule">disable-cloud-controller</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment"># debug: true</span>
<span class="token key atrule">cni</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> calico
</code></pre>
<p>Install the bins for master,</p>
<pre><code>curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=v1.24 sh -
systemctl enable rke2-server.service
</code></pre>
<p>Start the service,
systemctl start rke2-server.service</p>
<h2 id="workers"><a aria-hidden="true" class="anchor-heading icon-link" href="#workers"></a>Workers</h2>
<p>Create config.yaml files,</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">token</span><span class="token punctuation">:</span> your_secret_token
<span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//kubernetes.local<span class="token punctuation">:</span><span class="token number">9345</span>
<span class="token comment"># debug: true</span>
</code></pre>
<p>Install the bins for workers,</p>
<pre><code>curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" INSTALL_RKE2_CHANNEL=v1.24 sh -
systemctl enable rke2-agent.service
</code></pre>
<p>Start the service,
systemctl start rke2-agent.service</p>
<h2 id="airgap-note"><a aria-hidden="true" class="anchor-heading icon-link" href="#airgap-note"></a>Airgap note</h2>
<p>I airgap install quite a bit since bandwitdh can be precious and docker hub's ultimately not free.</p>
<p>To cache the images copy the files from the release, e.g., <a href="https://github.com/rancher/rke2/releases/download/v1.24.3%2Brke2r1/rke2-images-all.linux-amd64.txt">https://github.com/rancher/rke2/releases/download/v1.24.3%2Brke2r1/rke2-images-all.linux-amd64.txt</a>.</p>
<p>Create a script to pre-pull each of the images. The following assumes the downloaded images file above is called <code>rancher_images_file.txt</code>. It also assumes your docker deamon has been configured to use <a href="/dendron-tech-notes/notes/szlb6ma4pbf2mbt9vw4gk8r">Mirrors</a>.</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token keyword">while</span> <span class="token builtin class-name">read</span> p<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token function">docker</span> pull <span class="token string">"<span class="token variable">$p</span>"</span> 
<span class="token keyword">done</span> <span class="token operator">&#x3C;</span>rancher_images_file.txt
</code></pre>